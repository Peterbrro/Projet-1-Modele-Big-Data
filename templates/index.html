<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard Vélib'</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
<style>
    body { margin:0; font-family: 'Segoe UI', Tahoma, sans-serif; background:#f5f5f5; }
    h2 { text-align:center; margin:15px 0; color:#333; }

    .container { display:flex; width:100%; height:90vh; gap:20px; padding:10px; box-sizing:border-box; }
    #map { flex:2; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    .sidebar { flex:1; background:white; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.15); padding:15px; overflow-y:auto; display:flex; flex-direction:column; }

    .controls input, .controls select, .controls button {
        width:100%; padding:8px 10px; margin:5px 0; border:1px solid #ccc; border-radius:6px; font-size:14px;
    }
    .controls button { background:#4CAF50; color:white; font-weight:bold; cursor:pointer; border:none; transition:0.3s;}
    .controls button:hover { background:#45a049; }

    #stats { display:flex; justify-content:space-between; margin:10px 0; }
    .stat-card { flex:1; margin:0 5px; background:#fefefe; padding:10px; text-align:center; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.1);}
    .stat-card span { font-weight:bold; font-size:1.2em; color:#4CAF50; }

    #chart-container { margin-top:15px; padding:10px; border-radius:8px; box-shadow:0 3px 6px rgba(0,0,0,0.1); }

    .suggestions-list { position:absolute; background:white; border:1px solid #ccc; border-radius:6px; max-height:120px; overflow-y:auto; width:100%; z-index:10000;}
    .suggestion-item { padding:5px; cursor:pointer;}
    .suggestion-item:hover { background:#f0f0f0; }

    #route-info { text-align:center; margin-top:10px; font-weight:bold; color:#333; }
    .sidebar a { text-decoration:none; color:#2980b9; font-weight:bold; display:block; margin:10px 0; text-align:center; }
    .sidebar a:hover { color:#1f618d; }
</style>
</head>
<body>

<h2>Dashboard Vélib'</h2>

<div class="container">
    <div id="map"></div>
    <div class="sidebar">
        <div id="stats">
            <div class="stat-card">Total stations<br><span id="total-stations">0</span></div>
            <div class="stat-card">Total vélos<br><span id="total-bikes">0</span></div>
            <div class="stat-card">Stations vides<br><span id="empty-stations">0</span></div>
        </div>

        <div class="controls">
            <select id="filter">
                <option value="all">Toutes les stations</option>
                <option value="empty">Vides</option>
                <option value="low">Peu de vélos</option>
            </select>

            <input type="text" id="searchStation" placeholder="Rechercher une station...">

            <div style="position:relative">
                <input type="text" id="startAddress" placeholder="Départ (adresse ou station)">
                <div id="startSuggestions" class="suggestions-list"></div>
            </div>

            <div style="position:relative">
                <input type="text" id="endAddress" placeholder="Arrivée (adresse ou station)">
                <div id="endSuggestions" class="suggestions-list"></div>
            </div>

            <button id="calculateRoute">Calculer itinéraire vélo</button>
            <div id="route-info"></div>

            <a href="/stations">Voir toutes les stations</a>
        </div>

        <div id="chart-container">
            <canvas id="bikeChart" width="400" height="200"></canvas>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
// === Station data from Flask ===
var stations = {{ stations | tojson | safe }};

// === Map init ===
var map = L.map('map').setView([48.8566, 2.3522], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

var markers=[]; 
var bikeRouteLayer=null;

// --- Stats and markers ---
function updateStats(filtered){
    document.getElementById("total-stations").textContent=filtered.length;
    document.getElementById("total-bikes").textContent=filtered.reduce((sum,s)=>sum+(s.available_bikes||0),0);
    document.getElementById("empty-stations").textContent=filtered.filter(s=>(s.available_bikes||0)===0).length;
}

function drawMarkers(filter="all",search=""){
    markers.forEach(m=>map.removeLayer(m)); markers=[];
    let filtered=stations.filter(s=>{
        let show=filter==="all"||(filter==="empty"&&(s.available_bikes||0)===0)||(filter==="low"&&(s.available_bikes||0)<(s.capacity||1)/3);
        if(search) show=show && (s.name||"").toLowerCase().includes(search.toLowerCase());
        if(!s.latitude || !s.longitude) return false;
        return show;
    });
    filtered.forEach(s=>{
        let color=(s.available_bikes===0)?"#e74c3c":(s.available_bikes<(s.capacity||1)/3)?"#f1c40f":"#2ecc71";
        let popupContent = `<b>${s.name}</b><br>
            Vélos dispo: ${s.available_bikes||0}<br>
            Vélos mécaniques: ${s.extra?.mechanical || 0}<br>
            Vélos électriques: ${s.extra?.ebike || 0}<br>
            Capacité totale: ${s.capacity||0}`;
        let m=L.circleMarker([s.latitude,s.longitude],{radius:8,color,fillColor:color,fillOpacity:0.7})
            .bindPopup(popupContent).addTo(map);
        markers.push(m);
    });
    updateStats(filtered);
    if(window.heat) map.removeLayer(window.heat);
    window.heat=L.heatLayer(filtered.map(s=>[s.latitude,s.longitude,s.available_bikes||0]),{radius:25,blur:15,maxZoom:17}).addTo(map);
}
drawMarkers();

// --- Filters and search ---
document.getElementById("filter").addEventListener("change",()=>drawMarkers(document.getElementById("filter").value,document.getElementById("searchStation").value));
document.getElementById("searchStation").addEventListener("input",()=>drawMarkers(document.getElementById("filter").value,document.getElementById("searchStation").value));

// --- Chart.js ---
let topStations=stations.sort((a,b)=>(b.available_bikes||0)-(a.available_bikes||0)).slice(0,20);
new Chart(document.getElementById('bikeChart').getContext('2d'),{
    type:'bar',
    data:{labels:topStations.map(s=>s.name),datasets:[{label:'Vélos disponibles',data:topStations.map(s=>s.available_bikes),backgroundColor:'rgba(46,204,113,0.7)'}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{ticks:{autoSkip:false,maxTicksLimit:20}},y:{beginAtZero:true}}}
});

// --- Suggestions ---
async function geocode(addr){
    let resp=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`);
    let data=await resp.json(); if(data.length>0) return [parseFloat(data[0].lat),parseFloat(data[0].lon)]; return null;
}
function setupSuggestions(input,list){
    input.addEventListener("input",()=>{
        let val=input.value.toLowerCase(); list.innerHTML=""; if(!val) return;
        let matches=stations.filter(s=>(s.name||"").toLowerCase().includes(val)).slice(0,5);
        matches.forEach(s=>{
            let div=document.createElement("div"); div.textContent=s.name; div.className="suggestion-item";
            div.onclick=()=>{input.value=s.name; list.innerHTML="";}
            list.appendChild(div);
        });
    });
}
setupSuggestions(document.getElementById("startAddress"),document.getElementById("startSuggestions"));
setupSuggestions(document.getElementById("endAddress"),document.getElementById("endSuggestions"));

// --- ORS bike route ---
async function getBikeRoute(start,end){
    const apiKey="eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImE5Mjc3NDg4YTI5ZDQ4OGY4MzVjOTVkZmQ4YTcwNTYyIiwiaCI6Im11cm11cjY0In0="; // <-- remplace par ta clé ORS
    let resp=await fetch('https://api.openrouteservice.org/v2/directions/cycling-regular/geojson',{
        method:'POST', headers:{'Authorization':apiKey,'Content-Type':'application/json'},
        body:JSON.stringify({coordinates:[[start[1],start[0]],[end[1],end[0]]]})
    });
    return await resp.json();
}

document.getElementById("calculateRoute").addEventListener("click",async()=>{
    let startVal=document.getElementById("startAddress").value, endVal=document.getElementById("endAddress").value;
    let startCoords=null,endCoords=null;
    let stStart=stations.find(s=>(s.name||"").toLowerCase()===startVal.toLowerCase());
    if(stStart) startCoords=[stStart.latitude,stStart.longitude]; else startCoords=await geocode(startVal);
    let stEnd=stations.find(s=>(s.name||"").toLowerCase()===endVal.toLowerCase());
    if(stEnd) endCoords=[stEnd.latitude,stEnd.longitude]; else endCoords=await geocode(endVal);

    if(startCoords && endCoords){
        let geo=await getBikeRoute(startCoords,endCoords);
        if(bikeRouteLayer) map.removeLayer(bikeRouteLayer);
        bikeRouteLayer=L.geoJSON(geo,{style:{color:'#2980b9',weight:6,opacity:0.9}}).addTo(map);
        map.fitBounds(bikeRouteLayer.getBounds());

        if(geo.features && geo.features[0].properties.summary){
            let sum=geo.features[0].properties.summary;
            document.getElementById("route-info").textContent=`Distance: ${(sum.distance/1000).toFixed(2)} km, Durée: ${(sum.duration/60).toFixed(0)} min`;
        }

        let routeLine = L.polyline(geo.features[0].geometry.coordinates.map(c => [c[1], c[0]]));
        let threshold = 100;
        stations.forEach(s=>{
            let latlng=L.latLng(s.latitude,s.longitude);
            if(routeLine.getLatLngs().some(p => latlng.distanceTo(p)<threshold)){
                let popupContent = `<b>${s.name}</b><br>
                    Vélos dispo: ${s.available_bikes||0}<br>
                    Vélos mécaniques: ${s.extra?.mechanical || 0}<br>
                    Vélos électriques: ${s.extra?.ebike || 0}<br>
                    Capacité totale: ${s.capacity||0}`;
                L.circleMarker([s.latitude,s.longitude],{
                    radius:6,color:'#e67e22',fillColor:'#e67e22',fillOpacity:0.7
                }).bindPopup(popupContent).addTo(map);
            }
        });
    } else { alert("Départ ou arrivée introuvable"); }
});
</script>

</body>
</html>
